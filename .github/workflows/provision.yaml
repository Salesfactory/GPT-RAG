name: AZD Provision on Pull Request

on:
  pull_request:
    branches:
      - develop

jobs:
  provision:
    environment: develop
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install azd
        uses: Azure/setup-azd@v1.0.0

      - name: Log in with Azure (Client Credentials)
        if: ${{ env.AZURE_CREDENTIALS != '' }}
        run: |
          $info = $Env:AZURE_CREDENTIALS | ConvertFrom-Json -AsHashtable;
          Write-Host "::add-mask::$($info.clientSecret)"

          azd auth login `
            --client-id "$($info.clientId)" `
            --client-secret "$($info.clientSecret)" `
            --tenant-id "$($info.tenantId)"
        shell: pwsh
        env:
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Refresh Environment
        run: azd env refresh --no-prompt
        env:
          # Core Azure Settings
          AZURE_ENV_NAME: "develop-clew"
          AZURE_LOCATION: "eastus2"
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

          # Required Password Parameters
          vmUserInitialPassword: ${{ secrets.VM_USER_INITIAL_PASSWORD }}
          webAppAADClientSecret: ${{ secrets.AAD_CLIENT_SECRET }}
          webAppAADResetPassword: ${{ secrets.AAD_RESET_PASSWORD }}
          webAppEmailPass: ${{ secrets.EMAIL_PASSWORD }}

          # Stripe Integration
          stripeApiKey: ${{ secrets.STRIPE_API_KEY }}
          stripeSigningSecret: ${{ secrets.STRIPE_SIGNING_SECRET }}
          webAppStripeProductId: ${{ secrets.STRIPE_PRODUCT_ID }}
          webAppStripeFAPriceID: ${{ secrets.STRIPE_FA_PRICE_ID }}

          # Azure AD B2C Configuration
          webAppAADTenantName: ${{ secrets.AAD_TENANT_NAME }}
          webAppAADClientId: ${{ secrets.AAD_CLIENT_ID }}
          webAppAADPolicyName: ${{ secrets.AAD_POLICY_NAME }}
          webAppAADRedirectUri: ${{ secrets.AAD_REDIRECT_URI }}
          webAppAADAuthority: ${{ secrets.AAD_AUTHORITY }}
          webAppAADEditProfile: ${{ secrets.AAD_EDIT_PROFILE }}

          # Email Configuration
          webAppEmailHost: ${{ secrets.EMAIL_HOST }}
          webAppEmailUser: ${{ secrets.EMAIL_USER }}
          webAppInvitationLink: ${{ secrets.INVITATION_LINK }}

          # Azure Service Keys
          azureAiSearchApiKey: ${{ secrets.AI_SEARCH_API_KEY }}
          azureOpenAiApiKey: ${{ secrets.OPENAI_API_KEY }}

          # Orchestrator Settings
          orchestratorTavilyApiKey: ${{ secrets.TAVILY_API_KEY }}
          orchestratorFunctionsWorkerRuntime: "python"
          orchestratorSerperApiKey: ${{ secrets.SERPER_API_KEY }}

      # - name: Provision Azure Resources
      #   run: azd provision --no-prompt
      #   env:
      #     # Core Azure Settings
      #     AZURE_ENV_NAME: "develop-clew"
      #     AZURE_LOCATION: "eastus2"
      #     AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      #     # Required Password Parameters
      #     vmUserInitialPassword: ${{ secrets.VM_USER_INITIAL_PASSWORD }}
      #     webAppAADClientSecret: ${{ secrets.AAD_CLIENT_SECRET }}
      #     webAppAADResetPassword: ${{ secrets.AAD_RESET_PASSWORD }}
      #     webAppEmailPass: ${{ secrets.EMAIL_PASSWORD }}

      #     # Stripe Integration
      #     stripeApiKey: ${{ secrets.STRIPE_API_KEY }}
      #     stripeSigningSecret: ${{ secrets.STRIPE_SIGNING_SECRET }}
      #     webAppStripeProductId: ${{ secrets.STRIPE_PRODUCT_ID }}
      #     webAppStripeFAPriceID: ${{ secrets.STRIPE_FA_PRICE_ID }}

      #     # Azure AD B2C Configuration
      #     webAppAADTenantName: ${{ secrets.AAD_TENANT_NAME }}
      #     webAppAADClientId: ${{ secrets.AAD_CLIENT_ID }}
      #     webAppAADPolicyName: ${{ secrets.AAD_POLICY_NAME }}
      #     webAppAADRedirectUri: ${{ secrets.AAD_REDIRECT_URI }}
      #     webAppAADAuthority: ${{ secrets.AAD_AUTHORITY }}
      #     webAppAADEditProfile: ${{ secrets.AAD_EDIT_PROFILE }}

      #     # Email Configuration
      #     webAppEmailHost: ${{ secrets.EMAIL_HOST }}
      #     webAppEmailUser: ${{ secrets.EMAIL_USER }}
      #     webAppInvitationLink: ${{ secrets.INVITATION_LINK }}

      #     # Azure Service Keys
      #     azureAiSearchApiKey: ${{ secrets.AI_SEARCH_API_KEY }}
      #     azureOpenAiApiKey: ${{ secrets.OPENAI_API_KEY }}

      #     # Orchestrator Settings
      #     orchestratorTavilyApiKey: ${{ secrets.TAVILY_API_KEY }}
      #     orchestratorFunctionsWorkerRuntime: "python"
      #     orchestratorSerperApiKey: ${{ secrets.SERPER_API_KEY }}
